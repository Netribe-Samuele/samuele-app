<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Meta Graph API Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* Stili aggiuntivi specifici per GitHub Pages */
    .github-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #24292e;
      color: white;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .deploy-note {
      background: #f6f8fa;
      border: 1px solid #e1e4e8;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      font-size: 14px;
    }
    
    .deploy-note a {
      color: #0366d6;
      text-decoration: none;
      font-weight: 600;
    }
    
    .deploy-note a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

    <div class="container">
    <h1>Meta Graph API Dashboard</h1>
    
    <!-- Sezione 1: Login Facebook -->
    <div class="section">
      <h2>1. Login con Facebook</h2>
      <p>Accedi per ottenere l'accesso alle tue pagine Facebook.</p>
      <button id="fb-login-btn" class="btn" disabled>Accedi con Facebook</button>
      <div id="login-status" class="status"></div>
    </div>
    
    <!-- Sezione 2: Selezione Pagina -->
    <div class="section" id="page-section" style="display: none;">
      <h2>2. Seleziona una Pagina</h2>
      <div id="page-list" class="page-list"></div>
      <div id="selected-page" class="status info"></div>
    </div>
    
    <!-- Sezione 3: Azioni disponibili -->
    <div class="section" id="actions-section" style="display: none;">
        <h2>3. Azioni disponibili</h2>
        <div class="actions-grid">

            <div class="action-row post-specific-container">
                <button class="btn" onclick="listPostIds()"> Lista ID Post</button>
            </div>

            <div class="action-row post-specific-container">
                <button class="btn" onclick="getPostsWithComments()"> Ultimi Post con Commenti</button>
            </div>

            <div class="action-row post-specific-container">
                <div class="post-specific-wrapper">
                    <button class="btn" onclick="readSpecificPost()"> Leggi Post Specifico</button>
                    <div class="post-input-wrapper">
                        <input type="text" id="post-id-input" placeholder="ID Post (es: 123_456)">
                        <small class="input-hint">Incolla l'ID del post Facebook</small>
                    </div>
                </div>
            </div>

        </div>
    <div id="action-status" class="status"></div>
    </div>
    
    <!-- Sezione 4: Output -->
    <div class="section">
      <h2>üìä Risultati</h2>
      <pre id="output" class="output">Effettua il login e seleziona un'azione.</pre>
    </div>
    
    <!-- Informazioni server -->
    <div class="footer">
      <small>Server: <span id="server-status">Non connesso</span></small>
    </div>
  </div>

  <!-- Facebook SDK -->
  <div id="fb-root"></div>

  <script>
    // ========== CONFIGURAZIONE ==========
    const API_BASE_URL = "https://meta-graph-api-backend.onrender.com/";
    
    // ========== STATO APPLICAZIONE ==========
let selectedPage = null;
let pages = [];

// ========== INIZIALIZZAZIONE FACEBOOK SDK ==========
window.fbAsyncInit = function() {
  console.log('Facebook SDK caricato');
  
  FB.init({
    appId: '893895106664116', // App ID del tuo progetto
    cookie: true,
    xfbml: false,
    version: 'v19.0'
  });
  
  // Abilita il bottone login
  document.getElementById('fb-login-btn').disabled = false;
  console.log('Bottone login abilitato');
  
  // Controlla se gi√† loggato
  FB.getLoginStatus(function(response) {
    console.log('Stato login:', response.status);
    if (response.status === 'connected') {
      onLoginSuccess(response);
    }
  });
};

// Carica SDK Facebook
(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "https://connect.facebook.net/it_IT/sdk.js";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));

// ========== FUNZIONI LOGIN ==========
document.getElementById('fb-login-btn').addEventListener('click', function() {
  FB.login(function(response) {
    console.log('Risposta login:', response);
    if (!response.authResponse) {
      showStatus('Login annullato', 'error');
      return;
    }
    onLoginSuccess(response);
  }, {
    scope: 'pages_show_list,pages_read_engagement,pages_read_user_content'
  });
});

function onLoginSuccess(response) {
  showStatus('Login effettuato con successo!', 'success');
  
  // Ottieni le pagine gestite
  FB.api('/me/accounts', function(response) {
    console.log('Pagine ottenute:', response);
    if (response.error) {
      showStatus('Errore nel recupero pagine: ' + response.error.message, 'error');
      return;
    }
    
    pages = response.data || [];
    displayPages(pages);
    
    if (pages.length > 0) {
      // Mostra sezione pagine
      document.getElementById('page-section').style.display = 'block';
      showStatus(`Trovate ${pages.length} pagine`, 'info');
    } else {
      showStatus('Nessuna pagina trovata. Sei amministratore di una pagina?', 'warning');
    }
  });
}

// ========== GESTIONE PAGINE ==========
function displayPages(pages) {
  const container = document.getElementById('page-list');
  container.innerHTML = '';
  
  if (pages.length === 0) {
    container.innerHTML = '<div class="status warning">Nessuna pagina trovata.</div>';
    return;
  }
  
  pages.forEach(page => {
    const div = document.createElement('div');
    div.className = 'page-item';
    div.innerHTML = `
      <div class="page-info">
        <strong>${page.name}</strong>
        <div class="page-id">ID: ${page.id}</div>
      </div>
      <div class="page-token">Token: ${page.access_token.substring(0, 20)}...</div>
    `;
    
    div.onclick = () => selectPage(page);
    container.appendChild(div);
  });
}

function selectPage(page) {
  selectedPage = page;
  
  // Rimuovi selezione da tutte le pagine
  document.querySelectorAll('.page-item').forEach(el => {
    el.classList.remove('active');
  });
  
  // Aggiungi selezione alla pagina cliccata
  event.currentTarget.classList.add('active');
  
  // Mostra pagina selezionata
  document.getElementById('selected-page').innerHTML = `
    <strong>Pagina selezionata:</strong> ${page.name} (${page.id})
  `;
  
  // Mostra sezione azioni
  document.getElementById('actions-section').style.display = 'block';
  showActionStatus('Seleziona un\'azione', 'info');
}

// ========== FUNZIONI DEI BOTTONI ==========
async function listPostIds() {
  if (!selectedPage) {
    showActionStatus('Seleziona prima una pagina', 'error');
    return;
  }
  
  showActionStatus('Caricamento post...', 'info');
  
  try {
    // Simulazione - in realt√† dovrebbe chiamare il backend
    const mockData = {
      ids: [
        "123456789_987654321",
        "123456789_987654322", 
        "123456789_987654323",
        "123456789_987654324"
      ],
      total: 4
    };
    
    const output = `üìã ID POST TROVATI (${mockData.total})
${'‚îÄ'.repeat(50)}
${mockData.ids.map(id => `‚Ä¢ ${id}`).join('\n')}
${'‚îÄ'.repeat(50)}
‚ÑπÔ∏è Per leggere un post, copia un ID e incollalo nel campo sotto.`;
    
    document.getElementById('output').textContent = output;
    showActionStatus('‚úÖ Post caricati', 'success');
    
  } catch (error) {
    document.getElementById('output').textContent = `Errore: ${error.message}`;
    showActionStatus('‚ùå Errore', 'error');
  }
}

async function getPostsWithComments() {
  if (!selectedPage) {
    showActionStatus('Seleziona prima una pagina', 'error');
    return;
  }
  
  showActionStatus('Caricamento post con commenti...', 'info');
  
  try {
    // Simulazione
    const mockData = {
      posts: [
        {
          id: "123456789_987654321",
          message: "Ecco il nostro ultimo aggiornamento! üéâ",
          created_time: "2024-01-15T10:30:00+0000",
          comments: 3
        },
        {
          id: "123456789_987654322",
          message: "Nuovo prodotto in arrivo...",
          created_time: "2024-01-14T15:20:00+0000", 
          comments: 5
        }
      ]
    };
    
    const output = mockData.posts.map((post, index) => {
      return `üìù POST ${index + 1}
ID: ${post.id}
Data: ${new Date(post.created_time).toLocaleString('it-IT')}
Messaggio: ${post.message}
Commenti: ${post.comments}
${'‚îÄ'.repeat(50)}`;
    }).join('\n\n');
    
    document.getElementById('output').textContent = output;
    showActionStatus('‚úÖ Post con commenti caricati', 'success');
    
  } catch (error) {
    document.getElementById('output').textContent = `Errore: ${error.message}`;
    showActionStatus('‚ùå Errore', 'error');
  }
}

async function readSpecificPost() {
  if (!selectedPage) {
    showActionStatus('Seleziona prima una pagina', 'error');
    return;
  }
  
  const postId = document.getElementById('post-id-input').value.trim();
  if (!postId) {
    showActionStatus('Inserisci un ID post', 'error');
    return;
  }
  
  showActionStatus('Caricamento post...', 'info');
  
  try {
    // Per ora usa dati mock, ma puoi scommentare la chiamata al backend
    const mockData = {
      post: {
        id: postId,
        message: "Questo √® un post di esempio per dimostrare il funzionamento dell'applicazione.",
        created_time: new Date().toISOString(),
        permalink_url: `https://facebook.com/${postId}`
      },
      comments: [
        {
          id: "111111111",
          message: "Bellissimo post!",
          created_time: new Date(Date.now() - 3600000).toISOString()
        },
        {
          id: "222222222",
          message: "Grazie per la condivisione",
          created_time: new Date(Date.now() - 1800000).toISOString()
        }
      ],
      totalComments: 2
    };
    
    // Se vuoi usare il backend vero, scommenta queste righe:
    /*
    const response = await fetch(`${API_BASE_URL}/api/read-post`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        pageAccessToken: selectedPage.access_token,
        postId: postId
      })
    });
    
    if (!response.ok) throw new Error('Errore backend');
    const mockData = await response.json();
    */
    
    const output = `üìù POST
ID: ${mockData.post.id}
Data: ${new Date(mockData.post.created_time).toLocaleString('it-IT')}
URL: ${mockData.post.permalink_url}
Messaggio: ${mockData.post.message}
${'‚îÄ'.repeat(50)}
üí¨ COMMENTI (${mockData.totalComments})
${'‚îÄ'.repeat(50)}
${mockData.comments.map((comment, index) => {
  return `#${index + 1}
ID: ${comment.id}
Data: ${new Date(comment.created_time).toLocaleString('it-IT')}
Testo: ${comment.message}
${'‚îÄ'.repeat(30)}`;
}).join('\n\n')}`;
    
    document.getElementById('output').textContent = output;
    showActionStatus('‚úÖ Post caricato con successo', 'success');
    
  } catch (error) {
    const errorMessage = `‚ùå ERRORE
Messaggio: ${error.message}

üí° SUGGERIMENTI:
1. Verifica che il backend sia online: ${API_BASE_URL}
2. Controlla che l'ID post sia corretto
3. Assicurati di avere i permessi sulla pagina`;
    
    document.getElementById('output').textContent = errorMessage;
    showActionStatus('‚ùå Errore', 'error');
  }
}

// ========== FUNZIONI UTILITY ==========
function showStatus(message, type = 'info') {
  const element = document.getElementById('login-status');
  element.textContent = message;
  element.className = `status ${type}`;
}

function showActionStatus(message, type = 'info') {
  const element = document.getElementById('action-status');
  element.textContent = message;
  element.className = `status ${type}`;
}

// ========== INIZIALIZZAZIONE ==========
document.addEventListener('DOMContentLoaded', function() {
  console.log('Pagina caricata');
  
  // Controlla se il backend √® online
  checkBackendStatus();
  
  // Forza abilitazione del bottone dopo 3 secondi se FB SDK non risponde
  setTimeout(() => {
    if (document.getElementById('fb-login-btn').disabled) {
      console.log('Forzata abilitazione bottone login');
      document.getElementById('fb-login-btn').disabled = false;
      showStatus('SDK Facebook non risponde. Clicca per provare comunque.', 'warning');
    }
  }, 3000);
});

async function checkBackendStatus() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/health`);
    if (response.ok) {
      showStatus('‚úÖ Backend connesso', 'success');
    }
  } catch (error) {
    showStatus('‚ö†Ô∏è Backend non raggiungibile. Usando dati demo.', 'warning');
  }
}
  </script>
</body>
</html>
