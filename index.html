<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Meta Graph API Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    .github-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #24292e;
      color: white;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .deploy-note {
      background: #f6f8fa;
      border: 1px solid #e1e4e8;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      font-size: 14px;
    }
    
    .deploy-note a {
      color: #0366d6;
      text-decoration: none;
      font-weight: 600;
    }
    
    .deploy-note a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

<div class="container" style="display:none" id="app">

    <h1>Meta Graph API Dashboard</h1>

    <!-- Sezione 1: Login Facebook -->
    <div class="section">
      <h2>1. Login con Facebook</h2>
      <p>Accedi per ottenere l'accesso alle tue pagine Facebook.</p>
      <button id="fb-login-btn" class="btn" disabled>Accedi con Facebook</button>
      <div id="login-status" class="status"></div>
    </div>
    
    <!-- Sezione 2: Selezione Pagina -->
    <div class="section" id="page-section" style="display: none;">
      <h2>2. Seleziona una Pagina</h2>
      <div id="page-list" class="page-list"></div>
      <div id="selected-page" class="status info"></div>
    </div>
    
    <!-- Sezione 3: Azioni disponibili -->
    <div class="section" id="actions-section" style="display: none;">
        <h2>3. Azioni disponibili</h2>
        <div class="actions-grid">

            <div class="action-row post-specific-container">
                <button class="btn" onclick="listPostIds()"> Lista ID Post</button>
            </div>

            <div class="action-row post-specific-container">
                <button class="btn" onclick="getPostsWithComments()"> Ultimi Post con Commenti</button>
            </div>

            <div class="action-row post-specific-container">
                <div class="post-specific-wrapper">
                    <button class="btn" onclick="readSpecificPost()"> Leggi Post Specifico</button>
                    <div class="post-input-wrapper">
                        <input type="text" id="post-id-input" placeholder="ID Post (es: 123_456)">
                        <small class="input-hint">Incolla l'ID del post Facebook</small>
                    </div>
                </div>
            </div>

        </div>
    <div id="action-status" class="status"></div>
    </div>
    
    <!-- Sezione 4: Output -->
    <div class="section">
      <h2>üìä Risultati</h2>
      <pre id="output" class="output">Effettua il login e seleziona un'azione.</pre>
    </div>
    

      
    <div class="section">
        <h2>Benvenuto</h2>
        <p id="userWelcome">Caricamento...</p>
        <button onclick="logout()" class="btn">Logout</button>
    </div>

      <!-- Informazioni server -->
    <div class="footer">
      <small>Server: <span id="server-status">Non connesso</span></small>
    </div>
      
  </div>

  <!-- Facebook SDK -->
  <div id="fb-root"></div>


    <script>
(function checkAuth() {
  const VALID_EMAILS = ["s.bertele@netribegroup.com"];

  const authEmail = sessionStorage.getItem("auth_email");
  const authTime  = sessionStorage.getItem("auth_time");
  const authSession = sessionStorage.getItem("authSession");

  // ‚ùå BLOCCO TOTALE: manca qualcosa
  if (!authEmail || !authTime || !authSession) {
    sessionStorage.clear();
    window.location.replace("login.html");
    return;
  }

  // ‚ùå email non autorizzata
  if (!VALID_EMAILS.includes(authEmail)) {
    sessionStorage.clear();
    window.location.replace("login.html");
    return;
  }

  // ‚ùå sessione scaduta (8 ore)
  const hoursSinceLogin =
    (Date.now() - parseInt(authTime, 10)) / (1000 * 60 * 60);

  if (hoursSinceLogin > 8) {
    sessionStorage.clear();
    window.location.replace("login.html");
    return;
  }

  // ‚úÖ UTENTE AUTORIZZATO
  document.getElementById("userWelcome").textContent =
    `Accesso come: ${authEmail}`;
  document.getElementById("app").style.display = "block";

  console.log("‚úÖ Accesso autorizzato alla dashboard");
})();
</script>

  
  <script>
    // ========== CONFIGURAZIONE ==========
      const API_BASE_URL = "https://meta-graph-api-backend.onrender.com";
          
      // ========== STATO APPLICAZIONE ==========
      let selectedPage = null;
      let pages = [];
      let userAccessToken = '';
      
      // ========== INIZIALIZZAZIONE FACEBOOK SDK (SOLO PER LOGIN) ==========
      window.fbAsyncInit = function() {
        console.log('Facebook SDK caricato - Solo per login');
        
        // IMPORTANTE: xfbml false e status false
        FB.init({
          appId: '893895106664116',
          cookie: true,
          xfbml: false,  // Disabilita widget automatici
          version: 'v19.0'
        });
        
        // Abilita il bottone login
        document.getElementById('fb-login-btn').disabled = false;
        console.log('Bottone login abilitato');
        
        // NON controllare lo stato login automaticamente
        // Evita che FB.setAccessToken venga chiamato automaticamente
      };
      
      // Carica SDK Facebook
      (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "https://connect.facebook.net/it_IT/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));
      
      // ========== FUNZIONI LOGIN (SOLO PER OTTENERE TOKEN) ==========
      document.getElementById('fb-login-btn').addEventListener('click', function() {
        // Disabilita subito per evitere doppi click
        this.disabled = true;
        showStatus('Avvio login...', 'info');
        
        FB.login(function(response) {
          console.log('Risposta login:', response);
          
          // Riabilita il bottone
          document.getElementById('fb-login-btn').disabled = false;
          
          if (!response.authResponse) {
            showStatus('Login annullato', 'error');
            return;
          }
          
          // Ottieni il token ma NON usare FB.setAccessToken
          const accessToken = response.authResponse.accessToken;
          userAccessToken = accessToken;
          
          // Usa immediatamente fetch per ottenere le pagine
          fetchPagesWithToken(accessToken);
          
        }, {
          scope: 'pages_show_list,pages_read_engagement,pages_read_user_content,business_management'
        });
      });
      
      // ========== OTTIENI PAGINE USANDO FETCH (NO FB.api) ==========
      async function fetchPagesWithToken(accessToken) {
        showStatus('Recupero pagine...', 'info');
        
        try {
          // Usa fetch invece di FB.api per evitare FB.setAccessToken
          const response = await fetch(
            `https://graph.facebook.com/v19.0/me/accounts?access_token=${accessToken}`
          );
          
          if (!response.ok) {
            throw new Error(`Errore Graph API: ${response.status}`);
          }
          
          const data = await response.json();
          console.log('Pagine ottenute via fetch:', data);
          
          if (data.error) {
            showStatus('Errore Facebook: ' + data.error.message, 'error');
            return;
          }
          
          pages = data.data || [];
          displayPages(pages);
          
          if (pages.length > 0) {
            document.getElementById('page-section').style.display = 'block';
            showStatus(`‚úÖ Trovate ${pages.length} pagine`, 'success');
          } else {
            showStatus('Nessuna pagina trovata. Sei amministratore di una pagina?', 'warning');
          }
          
        } catch (error) {
          console.error('Errore fetch pagine:', error);
          showStatus('Errore nel recupero pagine: ' + error.message, 'error');
        }
      }
      
      // ========== GESTIONE PAGINE ==========
      function displayPages(pages) {
        const container = document.getElementById('page-list');
        container.innerHTML = '';
        
        if (pages.length === 0) {
          container.innerHTML = '<div class="status warning">Nessuna pagina trovata.</div>';
          return;
        }
        
        pages.forEach(page => {
          const div = document.createElement('div');
          div.className = 'page-item';
          div.innerHTML = `
            <div class="page-info">
              <strong>${page.name}</strong>
              <div class="page-id">ID: ${page.id}</div>
            </div>
            <div class="page-token">Token: ${page.access_token.substring(0, 20)}...</div>
          `;
          
          div.onclick = () => selectPage(page);
          container.appendChild(div);
        });
      }
      
      function selectPage(page) {
        selectedPage = page;
        
        // Rimuovi selezione da tutte le pagine
        document.querySelectorAll('.page-item').forEach(el => {
          el.classList.remove('active');
        });
        
        // Aggiungi selezione alla pagina cliccata
        event.currentTarget.classList.add('active');
        
        // Mostra pagina selezionata
        document.getElementById('selected-page').innerHTML = `
          <strong>Pagina selezionata:</strong> ${page.name} (${page.id})
        `;
        
        // Mostra sezione azioni
        document.getElementById('actions-section').style.display = 'block';
        showActionStatus('Seleziona un\'azione', 'info');
      }
      
      // ========== FUNZIONI DEI BOTTONI ==========
      async function listPostIds() {
        if (!selectedPage) {
          showActionStatus('Seleziona prima una pagina', 'error');
          return;
        }
        
        showActionStatus('Caricamento post...', 'info');
        
        try {
          const response = await fetch(`${API_BASE_URL}/api/list-post-ids`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              pageAccessToken: selectedPage.access_token,
              page: selectedPage.id,
              mode: 'published_posts',
              limit: 50
            })
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Errore ${response.status}: ${errorText}`);
          }
          
          const result = await response.json();
          
          const output = `üìã ID POST TROVATI (${result.ids.length})
      ${'‚îÄ'.repeat(50)}
      ${result.ids.map(id => `‚Ä¢ ${id}`).join('\n')}
      ${'‚îÄ'.repeat(50)}
      ‚ÑπÔ∏è Per leggere un post, copia un ID e incollalo nel campo sotto.`;
          
          document.getElementById('output').textContent = output;
          showActionStatus('‚úÖ Post caricati', 'success');
          
        } catch (error) {
          document.getElementById('output').textContent = `Errore: ${error.message}`;
          showActionStatus('‚ùå Errore', 'error');
        }
      }
      
      async function getPostsWithComments() {
        if (!selectedPage) {
          showActionStatus('Seleziona prima una pagina', 'error');
          return;
        }
        
        showActionStatus('Caricamento post con commenti...', 'info');
        
        try {
          const response = await fetch(`${API_BASE_URL}/api/posts-with-comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              pageAccessToken: selectedPage.access_token,
              page: selectedPage.id,
              postLimit: 5,
              commentLimit: 10
            })
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Errore ${response.status}: ${errorText}`);
          }
          
          const result = await response.json();
          
          let output = `üìù POST CON COMMENTI (${result.totalPosts || result.postsWithComments.length})
      ${'‚îÄ'.repeat(50)}`;
          
          if (result.postsWithComments && result.postsWithComments.length > 0) {
            result.postsWithComments.forEach((post, index) => {
              output += `\n\nPOST ${index + 1}
      ID: ${post.id}
      Data: ${new Date(post.created_time).toLocaleString('it-IT')}
      Messaggio: ${post.message ? post.message.substring(0, 100) + (post.message.length > 100 ? '...' : '') : '(Nessun messaggio)'}
      Commenti: ${post.comments ? post.comments.length : 0}`;
              
              if (post.comments && post.comments.length > 0) {
                post.comments.slice(0, 3).forEach((comment, commentIndex) => {
                  output += `\n  üí¨ ${commentIndex + 1}: ${comment.message ? comment.message.substring(0, 50) + (comment.message.length > 50 ? '...' : '') : '(Nessun testo)'}`;
                });
                if (post.comments.length > 3) output += `\n  ... e altri ${post.comments.length - 3} commenti`;
              }
              output += `\n${'‚îÄ'.repeat(50)}`;
            });
          } else {
            output += '\nNessun post con commenti trovato.';
          }
          
          document.getElementById('output').textContent = output;
          showActionStatus('‚úÖ Post con commenti caricati', 'success');
          
        } catch (error) {
          document.getElementById('output').textContent = `Errore: ${error.message}`;
          showActionStatus('‚ùå Errore', 'error');
        }
      }
      
      async function readSpecificPost() {
        if (!selectedPage) {
          showActionStatus('Seleziona prima una pagina', 'error');
          return;
        }
        
        const postId = document.getElementById('post-id-input').value.trim();
        if (!postId) {
          showActionStatus('Inserisci un ID post', 'error');
          return;
        }
        
        showActionStatus('Caricamento post...', 'info');
        
        try { 
          const response = await fetch(`${API_BASE_URL}/api/read-post`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              pageAccessToken: selectedPage.access_token,
              postId: postId
            })
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Errore ${response.status}: ${errorText}`);
          }
          
          const result = await response.json();
          
          if (result.error) {
            throw new Error(result.error);
          }
          
          const output = `üìù POST
      ID: ${result.post.id}
      Data: ${new Date(result.post.created_time).toLocaleString('it-IT')}
      URL: ${result.post.permalink_url || 'N/A'}
      Messaggio: ${result.post.message || '(Nessun messaggio)'}
      ${'‚îÄ'.repeat(50)}
      üí¨ COMMENTI (${result.totalComments || result.comments?.length || 0})
      ${'‚îÄ'.repeat(50)}
      ${result.comments && result.comments.length > 0 ? result.comments.map((comment, index) => {
        return `#${index + 1}
      ID: ${comment.id}
      Data: ${new Date(comment.created_time).toLocaleString('it-IT')}
      Testo: ${comment.message || '(Commento vuoto)'}
      ${'‚îÄ'.repeat(30)}`;
      }).join('\n\n') : 'Nessun commento trovato.'}`;
          
          document.getElementById('output').textContent = output;
          showActionStatus('‚úÖ Post caricato con successo', 'success');
          
        } catch (error) {
          const errorMessage = `‚ùå ERRORE
      Messaggio: ${error.message}
      
      üí° SUGGERIMENTI:
      1. Verifica che il backend sia online: ${API_BASE_URL}
      2. Controlla che l'ID post sia corretto
      3. Assicurati di avere i permessi sulla pagina
      4. Il token della pagina potrebbe essere scaduto`;
      
          document.getElementById('output').textContent = errorMessage;
          showActionStatus('‚ùå Errore', 'error');
        }
      }
      
      // ========== FUNZIONI UTILITY ==========
      function showStatus(message, type = 'info') {
        const element = document.getElementById('login-status');
        element.textContent = message;
        element.className = `status ${type}`;
      }
      
      function showActionStatus(message, type = 'info') {
        const element = document.getElementById('action-status');
        element.textContent = message;
        element.className = `status ${type}`;
      }
      
      // ========== INIZIALIZZAZIONE ==========
      document.addEventListener('DOMContentLoaded', function() {
        console.log('Pagina caricata');
        
        // Controlla se il backend √® online
        checkBackendStatus();
      });
      
      async function checkBackendStatus() {
        try {
          const response = await fetch(`${API_BASE_URL}/api/health`);
          if (response.ok) {
            const data = await response.json();
            document.getElementById('server-status').textContent = 'Connesso';
            document.getElementById('server-status').style.color = 'green';
            showStatus('‚úÖ Backend connesso', 'success');
          } else {
            throw new Error('Backend non risponde correttamente');
          }
        } catch (error) {
          document.getElementById('server-status').textContent = 'Non connesso';
          document.getElementById('server-status').style.color = 'red';
          showStatus('‚ö†Ô∏è Backend non raggiungibile. Verifica che il backend sia online.', 'warning');
        }
      }
   
   </script>
</body>
</html>
